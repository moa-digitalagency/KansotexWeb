{% extends "admin/base.html" %}

{% block title %}Édition des Sections{% endblock %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold mb-2 text-accent">Édition des Sections</h2>
    <p class="text-gray-400">Éditez le contenu de votre site section par section</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
    <!-- Sidebar - Liste des sections -->
    <div class="lg:col-span-1">
        <div class="bg-gray-800 rounded-lg p-4 sticky top-4">
            <h3 class="text-lg font-bold mb-4 text-accent">
                <i class="fas fa-list mr-2"></i>Sections
            </h3>
            <div class="space-y-2" id="section-list">
                {% for section in sections %}
                <button onclick="loadSection('{{ section.slug }}')" 
                        data-section="{{ section.slug }}"
                        class="section-btn w-full text-left px-4 py-3 rounded transition hover-bg-accent {% if loop.first %}bg-gray-700 border-l-4 border-l-accent{% else %}bg-gray-900{% endif %}">
                    <div class="font-medium">{{ section.name }}</div>
                    <div class="text-xs text-gray-500">{{ section.slug }}</div>
                </button>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Zone d'édition principale -->
    <div class="lg:col-span-3">
        <div id="section-editor" class="bg-gray-800 rounded-lg p-6">
            <div class="text-center text-gray-500 py-12">
                <i class="fas fa-edit text-4xl mb-4"></i>
                <p>Sélectionnez une section à gauche pour commencer</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal pour upload/crop d'image -->
<div id="image-crop-modal" class="fixed inset-0 bg-black bg-opacity-75 hidden z-50 flex items-center justify-center p-4">
    <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-screen overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-accent">Upload & Crop Image</h3>
                <button onclick="closeCropModal()" class="text-gray-400 hover-text-accent text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="crop-container">
                <input type="file" id="image-upload-input" accept="image/*" class="mb-4 w-full px-4 py-2 bg-gray-700 rounded border border-gray-600">
                <div id="image-preview" class="mb-4" style="max-height: 400px; overflow: hidden;"></div>
                <div class="flex justify-end space-x-4">
                    <button onclick="closeCropModal()" class="px-6 py-2 bg-gray-700 rounded hover:bg-gray-600 transition">
                        Annuler
                    </button>
                    <button onclick="saveCroppedImage()" class="px-6 py-2 bg-accent-gradient rounded transition">
                        <i class="fas fa-save mr-2"></i>Enregistrer
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let currentSection = null;
let currentField = null;
let cropper = null;

function loadSection(slug) {
    currentSection = slug;
    
    // Update active button
    document.querySelectorAll('.section-btn').forEach(btn => {
        btn.classList.remove('bg-gray-700', 'border-l-4', 'border-l-accent');
        btn.classList.add('bg-gray-900');
    });
    event.target.closest('.section-btn').classList.remove('bg-gray-900');
    event.target.closest('.section-btn').classList.add('bg-gray-700', 'border-l-4', 'border-l-accent');
    
    // Load section data
    fetch(`/admin/api/section/${slug}`)
        .then(res => res.json())
        .then(data => {
            renderSectionEditor(data);
        });
}

function renderSectionEditor(section) {
    const editor = document.getElementById('section-editor');
    let html = `
        <form onsubmit="saveSection(event)" id="section-form">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <div class="mb-6">
                <h2 class="text-2xl font-bold mb-2 text-accent">${section.name}</h2>
                <p class="text-gray-400">${section.description || ''}</p>
            </div>
            
            <div class="space-y-6">
    `;
    
    for (const [key, field] of Object.entries(section.fields)) {
        html += `
            <div class="bg-gray-900 rounded-lg p-4">
                <label class="block text-sm font-medium mb-2">${formatFieldName(key)}</label>
        `;
        
        if (field.type === 'image') {
            html += `
                <div class="flex items-center space-x-4">
                    ${field.image ? `<img src="/static/uploads/${field.image.file_name}" class="w-32 h-32 object-cover rounded">` : '<div class="w-32 h-32 bg-gray-700 rounded flex items-center justify-center"><i class="fas fa-image text-2xl text-gray-500"></i></div>'}
                    <div class="flex-1">
                        <button type="button" onclick="openImageUpload('${key}')" class="px-4 py-2 bg-accent-gradient rounded transition">
                            <i class="fas fa-upload mr-2"></i>Upload & Crop
                        </button>
                        <input type="hidden" name="${key}_type" value="image">
                        <input type="hidden" name="${key}_image_id" value="${field.image ? field.image.id : ''}" id="field_${key}_image_id">
                    </div>
                </div>
            `;
        } else if (field.type === 'text') {
            html += `
                <textarea name="${key}" rows="3" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded ring-accent">${field.value || ''}</textarea>
                <input type="hidden" name="${key}_type" value="text">
            `;
        } else {
            html += `
                <input type="text" name="${key}" value="${field.value || ''}" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded ring-accent">
                <input type="hidden" name="${key}_type" value="string">
            `;
        }
        
        html += `
            </div>
        `;
    }
    
    html += `
            </div>
            
            <div class="flex justify-end mt-6">
                <button type="submit" class="px-6 py-3 bg-accent-gradient rounded transition">
                    <i class="fas fa-save mr-2"></i>Enregistrer les modifications
                </button>
            </div>
        </form>
    `;
    
    editor.innerHTML = html;
}

function formatFieldName(key) {
    return key.split('_').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
}

function saveSection(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    fetch(`/admin/api/section/${currentSection}`, {
        method: 'POST',
        body: formData
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert('Section mise à jour avec succès!');
        }
    });
}

function openImageUpload(fieldKey) {
    currentField = fieldKey;
    document.getElementById('image-crop-modal').classList.remove('hidden');
    
    document.getElementById('image-upload-input').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = document.createElement('img');
                img.src = event.target.result;
                img.style.maxWidth = '100%';
                
                const preview = document.getElementById('image-preview');
                preview.innerHTML = '';
                preview.appendChild(img);
                
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(img, {
                    aspectRatio: 16 / 9,
                    viewMode: 1,
                    autoCropArea: 1
                });
            };
            reader.readAsDataURL(file);
        }
    };
}

function closeCropModal() {
    document.getElementById('image-crop-modal').classList.add('hidden');
    if (cropper) {
        cropper.destroy();
        cropper = null;
    }
    document.getElementById('image-preview').innerHTML = '';
    document.getElementById('image-upload-input').value = '';
}

function saveCroppedImage() {
    if (!cropper) return;
    
    cropper.getCroppedCanvas().toBlob(function(blob) {
        const formData = new FormData();
        formData.append('image', blob, 'cropped-image.jpg');
        formData.append('alt_text', currentField);
        formData.append('csrf_token', '{{ csrf_token() }}');
        
        fetch('/admin/upload-cropped', {
            method: 'POST',
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById(`field_${currentField}_image_id`).value = data.image.id;
                closeCropModal();
                loadSection(currentSection);
            }
        });
    });
}

// Load first section on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if sections %}
    loadSection('{{ sections[0].slug }}');
    {% endif %}
});
</script>
{% endblock %}
